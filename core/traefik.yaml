apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/manifest-generate-paths: .
spec:
  destination:
    namespace: default
    name: in-cluster
  project: core-components
  syncPolicy:
    automated: { }
  source:
    chart: traefik
    targetRevision: 37.2.0
    repoURL: https://traefik.github.io/charts
    helm:
      releaseName: traefik
      valuesObject:
        entryPoints:
          web:
            address: ":80"
          websecure:
            address: ":443"
        certificatesResolvers:
          pmcdio:
            acme:
              email: "patrickjmcd@gmail.com"
              storage: "/data/acme.json"       # Path to store the certificate information.
              dnsChallenge:
                provider: cloudflare
                delayBeforeCheck: 0
        env:
          - name: CF_DNS_API_TOKEN
            valueFrom:
              secretKeyRef:
                name: cloudflare-pmcdio-credentials
                key: CLOUDFLARE_TOKEN
        deployment:
          initContainers:
            - name: volume-permissions
              image: busybox:latest
              command: [ "sh", "-c", "touch /data/acme.json; chmod -v 600 /data/acme.json" ]
              volumeMounts:
                - mountPath: /data
                  name: data
        podSecurityContext:
          fsGroup: 65532
          fsGroupChangePolicy: "OnRootMismatch"
        ingressRoute:
          dashboard:
            enabled: true
            matchRule: Host(`traefic.x.pmcd.io`)
            entryPoints:
              - web
              - wesecure
        providers:
          kubernetesGateway:
            enabled: true
        gateway:
          listeners:
            web:
              namespacePolicy:
                from: All